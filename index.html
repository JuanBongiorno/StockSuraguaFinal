<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Stock Suragua</title>
    
    <link rel="icon" href="logo.png" type="image/png"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background: url('https://images.unsplash.com/photo-1518837695005-2083093ee35b?q=80&w=2070&auto=format&fit=crop') no-repeat center center fixed; background-size: cover; min-height: 100vh; color: #333; }
        .glass-panel { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); }
        .modern-input-group { display: flex; align-items: center; background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 12px; padding: 10px 15px; margin-bottom: 15px; transition: 0.3s; }
        .modern-input-group:focus-within { background: rgba(255, 255, 255, 0.95); border-color: #007bff; box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2); }
        .modern-input-icon { font-size: 1.2rem; color: #007bff; margin-right: 12px; opacity: 0.8; }
        .modern-input { border: none; background: transparent; width: 100%; outline: none; color: #333; font-weight: 500; font-size: 0.95rem; }
        .full-screen-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .header-app { background: rgba(255, 255, 255, 0.90); backdrop-filter: blur(10px); padding: 10px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .stock-card { padding: 15px; margin-bottom: 15px; transition: 0.3s; border-left: 6px solid #007bff; border-radius: 15px; }
        .stock-card.repuesto { border-left-color: #28a745; }
        .btn-circle { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .menu-card { cursor: pointer; transition: 0.3s; text-align: center; padding: 40px 20px; border-radius: 20px; }
        .menu-card:hover { transform: translateY(-5px); background: rgba(255,255,255, 0.9); }
        .menu-icon { font-size: 3.5rem; color: #007bff; margin-bottom: 15px; }

        .repuestos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
        .repuesto-selector { background: white; border: 1px solid #ddd; border-radius: 12px; padding: 8px; text-align: center; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .repuesto-selector.active { border-color: #28a745; background: #f0fff4; box-shadow: 0 0 10px rgba(40, 167, 69, 0.2); }
        .rep-name { font-size: 0.75rem; font-weight: 600; display: block; margin-bottom: 5px; height: 32px; overflow: hidden; display: flex; align-items: center; justify-content: center; line-height: 1.2; }
        .rep-controls { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-qty { width: 26px; height: 26px; border-radius: 50%; border: 1px solid #ddd; background: white; font-weight: bold; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-qty:hover { background: #eee; }
        .rep-qty { font-weight: bold; font-size: 0.9rem; min-width: 20px; }

        .history-box { border-radius: 15px; padding: 20px; margin-bottom: 18px; border: 1px solid rgba(0,0,0,0.1); background: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .history-box.taller { border-left: 8px solid #007bff; background: #f8fbff; }
        .history-box.manual { border-left: 8px solid #6c757d; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .history-op-badge { background: #007bff; color: white; padding: 4px 14px; border-radius: 25px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
        .history-time { font-size: 0.8rem; color: #777; }
        .history-main-text { font-size: 1.15rem; font-weight: 600; color: #222; }
        .history-sub-text { font-size: 0.95rem; color: #555; margin-bottom: 10px; border-left: 3px solid #ddd; padding-left: 10px; }
        .history-parts-list { font-size: 0.95rem; color: #157347; font-weight: 600; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #bbb; line-height: 1.5; }

        .history-card-mini { background: rgba(255,255,255,0.9); border-radius: 12px; padding: 10px 15px; margin-bottom: 10px; border-left: 4px solid #007bff; }
        .history-date { font-size: 0.7rem; color: #888; }
        .history-user { font-size: 0.75rem; color: #555; font-weight: bold; background: #f0f0f0; padding: 2px 8px; border-radius: 10px; }
        .history-machine { font-size: 0.9rem; color: #007bff; font-weight: 600; }
    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="loginScreen" class="full-screen-container">
        <div class="glass-panel p-5 text-center" style="width: 400px;">
            <img src="./Suragua-Logotipo-removebg-preview.png" class="img-fluid mb-4" style="max-width: 180px;">
            <div class="modern-input-group">
                <i class="bi bi-person-circle modern-input-icon"></i>
                <select id="usernameInput" class="modern-input">
                    <option value="" disabled selected>Usuario</option>
                    <option value="oficina">Oficina</option>
                    <option value="taller">Taller</option>
                    <option value="planta">Planta</option>
                    <option value="mauro">Mauro</option>
                    <option value="javier">Javier</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
            <div class="modern-input-group">
                <i class="bi bi-lock-fill modern-input-icon"></i>
                <input type="password" id="passwordInput" class="modern-input" placeholder="Contraseña">
            </div>
            <button onclick="login()" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow">INGRESAR</button>
            <p id="loginError" class="text-danger small mt-3 fw-bold" style="display:none;">Error de credenciales</p>
        </div>
    </div>

    <!-- 2. MENÚ TALLER -->
    <div id="tallerMenuScreen" class="full-screen-container" style="display: none;">
        <div class="container text-center">
            <h2 class="fw-bold text-white mb-5">Panel de Trabajo</h2>
            <div class="row justify-content-center g-4">
                <div class="col-md-4"><div class="glass-panel menu-card" onclick="showDailyForm()"><i class="bi bi-pencil-square menu-icon"></i><h4>Carga Diaria</h4></div></div>
                <div class="col-md-4"><div class="glass-panel menu-card" onclick="showDashboard()"><i class="bi bi-boxes menu-icon text-success"></i><h4>Control Stock</h4></div></div>
            </div>
            <button onclick="logout()" class="btn btn-danger rounded-pill px-5 mt-5 shadow">Cerrar Sesión</button>
        </div>
    </div>

    <!-- 3. FORMULARIO TALLER -->
    <div id="tallerFormScreen" class="full-screen-container" style="display: none; align-items: flex-start;">
        <div class="container-fluid" style="max-width: 1200px;">
            <div class="row g-4">
                <div class="col-lg-5">
                    <div class="glass-panel p-4">
                        <h4 class="fw-bold text-primary mb-3 border-bottom pb-2">Nueva Carga</h4>
                        <div class="modern-input-group bg-light"><input type="text" id="reportDate" class="modern-input" readonly></div>
                        <div class="modern-input-group">
                            <i class="bi bi-person-fill modern-input-icon"></i>
                            <input type="text" id="reportOperator" class="modern-input" placeholder="Nombre del Operario">
                        </div>
                        <div class="modern-input-group">
                            <select id="reportMachineType" class="modern-input">
                                <option value="" disabled selected>Seleccionar Máquina (+1 al stock)</option>
                            </select>
                        </div>
                        <label class="small fw-bold mb-2">Repuestos utilizados (Resta cantidad al stock):</label>
                        <div id="repuestosChecklist" class="repuestos-grid mb-3"></div>
                        <div class="modern-input-group"><input type="text" id="reportActivity" class="modern-input" placeholder="Actividad Realizada"></div>
                        <div class="modern-input-group"><textarea id="reportObs" class="modern-input" placeholder="Observaciones extras..." rows="2"></textarea></div>
                        <button id="btnSaveReport" onclick="saveDailyReport()" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm">GUARDAR REPORTE</button>
                    </div>
                </div>
                <div class="col-lg-7">
                    <div class="glass-panel p-4 d-flex flex-column" style="height: 850px;">
                        <h5 class="fw-bold mb-3 d-flex justify-content-between">Historial Reciente <i class="bi bi-clock-history"></i></h5>
                        <div id="tallerHistoryList" style="flex-grow: 1; overflow-y: auto; padding-right: 10px;"></div>
                        <button onclick="backToMenu()" class="btn btn-outline-danger w-100 mt-3 rounded-pill fw-bold">VOLVER AL MENÚ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. PANEL ADMINISTRADOR -->
    <div id="adminScreen" class="full-screen-container" style="display: none; align-items: flex-start;">
        <div class="container glass-panel p-4">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                <h3 class="fw-bold m-0"><i class="bi bi-shield-lock-fill text-primary"></i> Panel Administrador</h3>
                <div class="d-flex gap-2">
                    <button onclick="showDashboard()" class="btn btn-info btn-sm rounded-pill px-3 fw-bold">Ver Stock</button>
                    <button onclick="logout()" class="btn btn-danger btn-sm rounded-pill px-3">Salir</button>
                </div>
            </div>
            <div id="adminControls" class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="small fw-bold">Buscar por operario:</label>
                    <input type="text" id="adminFilterUser" class="form-control rounded-pill" placeholder="Nombre..." onkeyup="loadAdminHistory()">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button onclick="exportToExcel()" class="btn btn-success w-100 rounded-pill fw-bold"><i class="bi bi-file-earmark-excel"></i> Descargar Excel</button>
                </div>
            </div>
            <div class="table-responsive"><table class="table table-hover">
                <thead class="table-dark"><tr><th>Fecha</th><th>Operario</th><th>Máquina</th><th>Actividad</th><th>Repuestos</th><th>Obs.</th></tr></thead>
                <tbody id="adminReportsTable"></tbody>
            </table></div>
        </div>
    </div>

    <!-- 5. STOCK DASHBOARD -->
    <div id="dashboardScreen" style="display: none;">
        <div class="header-app sticky-top px-4">
            <div class="d-flex align-items-center">
                <img src="./Suragua-Logotipo-removebg-preview.png" style="height: 40px;" class="me-3">
                <button onclick="backToMenu()" class="btn btn-outline-primary btn-sm rounded-pill fw-bold">Regresar</button>
            </div>
            <div class="d-flex align-items-center gap-3">
                <span id="userDisplay" class="badge bg-primary px-3 py-2">USER</span>
                <button class="btn btn-dark rounded-circle shadow" data-bs-toggle="modal" data-bs-target="#historyModal" onclick="loadHistory()"><i class="bi bi-clock-history"></i></button>
                <button onclick="logout()" class="btn btn-danger rounded-pill btn-sm px-3 shadow">Salir</button>
            </div>
        </div>
        <div class="container pb-5">
            <div class="glass-panel p-3 mb-4">
                <div class="row align-items-center">
                    <div class="col-md-8"><input type="text" id="searchInput" class="form-control rounded-pill" placeholder="Buscar en stock..." onkeyup="filterItems()"></div>
                    <div class="col-md-4 text-end" id="btnContainerAdd"><button class="btn btn-primary rounded-pill px-4 shadow" data-bs-toggle="modal" data-bs-target="#addItemModal">+ Nuevo Item</button></div>
                </div>
            </div>
            <div id="itemsContainer" class="row g-4"></div>
        </div>
    </div>

    <!-- MODALES -->
    <div class="modal fade" id="historyModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="fw-bold">Movimientos de Stock</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="historyContainer" style="max-height: 600px; overflow-y: auto; padding: 25px;"></div></div></div></div>
    <div class="modal fade" id="addItemModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-3"><div class="modal-header border-0"><h5 class="fw-bold">Nuevo Producto</h5></div><div class="modal-body"><input type="text" id="newItemName" class="form-control mb-3" placeholder="Nombre (Ej: Maquina 1)"><select id="newItemType" class="form-select mb-3"><option value="dispenser">Máquina/Dispenser</option><option value="repuesto">Repuesto</option></select><input type="number" id="newItemQty" class="form-control" placeholder="Stock Inicial" value="0"></div><div class="modal-footer border-0"><button class="btn btn-primary w-100 rounded-pill" onclick="addNewItem()">Guardar</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove, query, limitToLast, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyCor_UwHJPZ-O1f1xA08OTazZ3RXW9DJkI", authDomain: "stocksuragua.firebaseapp.com", databaseURL: "https://stocksuragua-default-rtdb.firebaseio.com", projectId: "stocksuragua", storageBucket: "stocksuragua.firebasestorage.app", messagingSenderId: "1039448545276", appId: "1:1039448545276:web:5d080373c6ba8cdb4d4479" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let currentUser = null;
        let selectedRepuestos = {}; 
        let globalItems = {};
        let unsubTaller, unsubItems, unsubHistory, unsubAdmin, unsubRep;

        const credentials = { 
            oficina: "Broncel3876", 
            taller: "taller3876", 
            planta: "planta3876", 
            admin: "admin3876",
            mauro: "suragua123",
            javier: "suragua159"
        };

        // Usuarios con acceso al panel de taller
        const restrictedUsers = ['mauro', 'javier', 'taller'];

        window.login = () => {
            const u = document.getElementById('usernameInput').value;
            const p = document.getElementById('passwordInput').value;
            if (credentials[u] === p) {
                currentUser = u;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('userDisplay').innerText = u.toUpperCase();
                
                if(u === 'admin') { 
                    document.getElementById('adminScreen').style.display = 'flex'; 
                    loadAdminHistory(); 
                } else if(restrictedUsers.includes(u)) { 
                    document.getElementById('tallerMenuScreen').style.display = 'flex'; 
                } else {
                    showDashboard();
                }
            } else document.getElementById('loginError').style.display = 'block';
        };

        window.logout = () => location.reload();

        window.showDailyForm = () => {
            document.getElementById('tallerMenuScreen').style.display = 'none';
            document.getElementById('tallerFormScreen').style.display = 'flex';
            
            const operatorInput = document.getElementById('reportOperator');
            
            if (['mauro', 'javier'].includes(currentUser)) {
                operatorInput.value = currentUser.charAt(0).toUpperCase() + currentUser.slice(1);
                operatorInput.readOnly = true;
                operatorInput.parentElement.style.opacity = "0.7";
            } else {
                operatorInput.value = "";
                operatorInput.readOnly = false;
                operatorInput.parentElement.style.opacity = "1";
            }

            updateTime(); loadFormSync(); loadTallerHistory();
        };

        window.showDashboard = () => {
            document.getElementById('tallerMenuScreen').style.display = 'none';
            document.getElementById('adminScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            
            // Solo admin/oficina/planta pueden añadir nuevos productos
            if(restrictedUsers.includes(currentUser)) {
                document.getElementById('btnContainerAdd').style.display = 'none';
            } else {
                document.getElementById('btnContainerAdd').style.display = 'block';
            }

            loadItems(); loadHistory();
        };

        window.backToMenu = () => {
            document.getElementById('tallerFormScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'none';
            if(currentUser === 'admin') document.getElementById('adminScreen').style.display = 'flex';
            else if(restrictedUsers.includes(currentUser)) document.getElementById('tallerMenuScreen').style.display = 'flex';
        };

        function updateTime() {
            const now = new Date();
            document.getElementById('reportDate').value = now.toLocaleDateString('es-AR') + ' ' + now.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'});
        }

        function loadFormSync() {
            if(unsubRep) unsubRep();
            unsubRep = onValue(ref(db, 'items'), (snap) => {
                const data = snap.val(); globalItems = data || {};
                const contRep = document.getElementById('repuestosChecklist');
                const selectMaq = document.getElementById('reportMachineType');
                contRep.innerHTML = '';
                const currentSelection = selectMaq.value;
                selectMaq.innerHTML = '<option value="" disabled selected>Seleccionar Máquina (+1 al stock)</option>';
                
                if(!data) return;

                Object.keys(data).forEach(id => {
                    const item = data[id];
                    if(item.type === 'repuesto') {
                        const d = document.createElement('div'); 
                        d.className = `repuesto-selector ${selectedRepuestos[id] ? 'active' : ''}`;
                        d.id = `selector-${id}`;
                        const currentQty = selectedRepuestos[id] ? selectedRepuestos[id].qty : 0;
                        d.innerHTML = `
                            <span class="rep-name">${item.name}<br>(${item.qty})</span>
                            <div class="rep-controls">
                                <button class="btn-qty" onclick="changeRepQty('${id}', '${item.name}', -1)">-</button>
                                <span class="rep-qty" id="qty-val-${id}">${currentQty}</span>
                                <button class="btn-qty" onclick="changeRepQty('${id}', '${item.name}', 1)">+</button>
                            </div>
                        `;
                        contRep.appendChild(d);
                    } else if(item.type === 'dispenser') {
                        const opt = document.createElement('option');
                        opt.value = item.name; opt.innerText = item.name;
                        selectMaq.appendChild(opt);
                    }
                });
                selectMaq.value = currentSelection;
            });
        }

        window.changeRepQty = (id, name, delta) => {
            if (!selectedRepuestos[id]) {
                if (delta <= 0) return;
                selectedRepuestos[id] = { name, qty: 0 };
            }
            selectedRepuestos[id].qty += delta;
            if (selectedRepuestos[id].qty <= 0) {
                delete selectedRepuestos[id];
                document.getElementById(`selector-${id}`).classList.remove('active');
                document.getElementById(`qty-val-${id}`).innerText = '0';
            } else {
                document.getElementById(`selector-${id}`).classList.add('active');
                document.getElementById(`qty-val-${id}`).innerText = selectedRepuestos[id].qty;
            }
        };

        window.saveDailyReport = async () => {
            const op = document.getElementById('reportOperator').value;
            const mc = document.getElementById('reportMachineType').value;
            const ac = document.getElementById('reportActivity').value;
            const obs = document.getElementById('reportObs').value;
            const btn = document.getElementById('btnSaveReport');
            const fechaTxt = document.getElementById('reportDate').value;

            if(!op || !mc || !ac) return alert("Completa Operario, Máquina y Actividad");
            btn.disabled = true;

            try {
                const repArray = Object.values(selectedRepuestos);
                const repDetailed = repArray.length > 0 
                    ? repArray.map(r => `${r.name} (x${r.qty})`).join(', ') 
                    : 'Ninguno';
                
                await push(ref(db, 'taller_reports'), { 
                    date: fechaTxt, 
                    operator: op, 
                    machine: mc, 
                    activity: ac, 
                    observations: obs, 
                    repuestos: repDetailed, 
                    timestamp: Date.now() 
                });
                
                await push(ref(db, 'history'), { 
                    type: 'taller',
                    user: op.toUpperCase(), 
                    machine: mc,
                    activity: ac,
                    repuestos: repDetailed,
                    date: fechaTxt, 
                    timestamp: Date.now() 
                });

                // 1. SUMAR +1 A LA MÁQUINA REPARADA SELECCIONADA
                let mId = Object.keys(globalItems).find(id => globalItems[id].name === mc);
                if(mId) await update(ref(db, `items/${mId}`), { qty: globalItems[mId].qty + 1 });

                // 2. RESTAR -1 A "Dispenser a reparar" (Lógica automática de taller)
                if (restrictedUsers.includes(currentUser)) {
                    let repairId = Object.keys(globalItems).find(id => 
                        globalItems[id].name.trim().toLowerCase() === "dispenser a reparar"
                    );
                    if (repairId) {
                        const currentRepairQty = globalItems[repairId].qty || 0;
                        await update(ref(db, `items/${repairId}`), { qty: Math.max(0, currentRepairQty - 1) });
                    }
                }

                // 3. RESTAR REPUESTOS UTILIZADOS
                for(let id in selectedRepuestos) {
                    if(globalItems[id]) {
                        const newStock = Math.max(0, globalItems[id].qty - selectedRepuestos[id].qty);
                        await update(ref(db, `items/${id}`), { qty: newStock });
                    }
                }

                alert("¡Carga terminada con éxito! ✅");
                resetForm();
            } catch (e) { alert("Error: " + e.message); }
            finally { btn.disabled = false; }
        };

        function resetForm() {
            if (!['mauro', 'javier'].includes(currentUser)) {
                document.getElementById('reportOperator').value = '';
            }
            document.getElementById('reportMachineType').value = '';
            document.getElementById('reportActivity').value = '';
            document.getElementById('reportObs').value = '';
            selectedRepuestos = {}; 
            updateTime();
            loadFormSync();
        }

        function loadTallerHistory() {
            if(unsubTaller) unsubTaller();
            unsubTaller = onValue(query(ref(db, 'taller_reports'), limitToLast(12)), (snap) => {
                const list = document.getElementById('tallerHistoryList'); list.innerHTML = '';
                const data = snap.val(); if(!data) return;
                Object.values(data).sort((a,b) => b.timestamp - a.timestamp).forEach(i => {
                    list.innerHTML += `
                        <div class="history-card-mini">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="history-date">${i.date}</span>
                                <span class="history-user">${i.operator}</span>
                            </div>
                            <div class="history-machine">${i.machine}</div>
                            <div class="history-activity">${i.activity}</div>
                            <div class="history-tools"><i class="bi bi-wrench-adjustable"></i> ${i.repuestos}</div>
                        </div>`;
                });
            });
        }

        window.loadAdminHistory = () => {
            if(unsubAdmin) unsubAdmin();
            const f = document.getElementById('adminFilterUser').value.toLowerCase();
            unsubAdmin = onValue(ref(db, 'taller_reports'), (snap) => {
                const tbody = document.getElementById('adminReportsTable'); tbody.innerHTML = '';
                const data = snap.val(); if(!data) return;
                Object.values(data).sort((a,b) => b.timestamp - a.timestamp).forEach(i => {
                    if(i.operator.toLowerCase().includes(f)) {
                        tbody.innerHTML += `<tr><td class="small">${i.date}</td><td class="fw-bold">${i.operator}</td><td><span class="badge bg-primary">${i.machine}</span></td><td>${i.activity}</td><td class="small">${i.repuestos || '-'}</td><td class="small italic">${i.observations || '-'}</td></tr>`;
                    }
                });
            });
        };

        window.exportToExcel = () => {
            const filterValue = document.getElementById('adminFilterUser').value.toLowerCase();
            get(ref(db, 'taller_reports')).then((snap) => {
                const raw = snap.val(); 
                if(!raw) return alert("No hay datos para exportar");
                let reportData = Object.values(raw);
                if (filterValue) {
                    reportData = reportData.filter(r => r.operator.toLowerCase().includes(filterValue));
                }
                const data = reportData.map(r => ({ Fecha: r.date, Operario: r.operator, Máquina: r.machine, Actividad: r.activity, Repuestos: r.repuestos, Observaciones: r.observations }));
                const ws = XLSX.utils.json_to_sheet(data); 
                const wb = XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb, ws, "Taller");
                const fileName = `Reporte_Taller_${new Date().toLocaleDateString()}.xlsx`;
                XLSX.writeFile(wb, fileName);
            });
        };

        function loadItems() {
            if(unsubItems) unsubItems();
            unsubItems = onValue(ref(db, 'items'), (snap) => {
                const cont = document.getElementById('itemsContainer'); cont.innerHTML = '';
                const data = snap.val(); globalItems = data || {};
                if(data) Object.keys(data).forEach(id => renderItem(id, data[id]));
            });
        }

        function renderItem(id, item) {
            const isDisp = item.type === 'dispenser';
            const isRepairItem = item.name.trim().toLowerCase() === "dispenser a reparar";
            
            const card = document.createElement('div'); card.className = 'col-md-4 item-card-wrapper';
            card.setAttribute('data-name', item.name.toLowerCase());
            
            // Lógica de permisos solicitada:
            // 1. Si el usuario es 'mauro' o 'javier', NO puede modificar NADA (canEdit = false).
            // 2. Si el usuario es 'taller', SOLO puede modificar "dispenser a reparar".
            // 3. Otros usuarios (admin, oficina, planta) pueden modificar todo.
            
            let canEdit = true;
            if (currentUser === 'mauro' || currentUser === 'javier') {
                canEdit = false;
            } else if (currentUser === 'taller') {
                canEdit = isRepairItem;
            }

            const controlsHtml = canEdit ? 
                `<button class="btn btn-circle btn-outline-danger shadow-sm" onclick="updateStock('${id}', ${item.qty}, -1, '${item.name}')">-</button>
                 <span class="fs-4 fw-bold">${item.qty}</span>
                 <button class="btn btn-circle btn-outline-success shadow-sm" onclick="updateStock('${id}', ${item.qty}, 1, '${item.name}')">+</button>` :
                `<span class="fs-4 fw-bold w-100 text-center">${item.qty}</span>`;

            // El botón de borrar solo para usuarios no restringidos
            const deleteHtml = restrictedUsers.includes(currentUser) ? '' : `<button onclick="deleteItem('${id}', '${item.name}')" class="btn text-danger btn-sm p-0"><i class="bi bi-trash"></i></button>`;

            card.innerHTML = `
                <div class="glass-panel stock-card ${isDisp?'':'repuesto'} shadow-sm">
                    <div class="d-flex justify-content-between">
                        <h6 class="fw-bold">${item.name}</h6>
                        ${deleteHtml}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3 p-2 bg-white rounded-3">
                        ${controlsHtml}
                    </div>
                </div>`;
            document.getElementById('itemsContainer').appendChild(card);
        }

        window.updateStock = (id, cur, amt, name) => {
            const isRepairItem = name.trim().toLowerCase() === "dispenser a reparar";
            
            // Bloqueo estricto por función
            if (currentUser === 'mauro' || currentUser === 'javier') return;
            if (currentUser === 'taller' && !isRepairItem) return;
            
            if(cur + amt < 0) return;
            update(ref(db, `items/${id}`), { qty: cur + amt });
            push(ref(db, 'history'), { 
                type: 'manual',
                user: currentUser.toUpperCase(), 
                action: amt>0?'Ingreso':'Retiro', 
                desc: `${amt>0?'Sumó':'Restó'} ${Math.abs(amt)} a ${name}`, 
                date: new Date().toLocaleString(), 
                timestamp: Date.now() 
            });
        };

        window.loadHistory = () => {
            if(unsubHistory) unsubHistory();
            unsubHistory = onValue(query(ref(db, 'history'), limitToLast(40)), (snap) => {
                const cont = document.getElementById('historyContainer'); cont.innerHTML = '';
                const data = snap.val(); if(!data) return;
                Object.values(data).sort((a,b) => b.timestamp - a.timestamp).forEach(l => {
                    if(l.type === 'taller') {
                        cont.innerHTML += `
                        <div class="history-box taller">
                            <div class="history-header">
                                <span class="history-op-badge">${l.user}</span>
                                <span class="history-time">${l.date}</span>
                            </div>
                            <div class="history-main-text"><i class="bi bi-box-seam-fill"></i> Armó: ${l.machine} (+1)</div>
                            <div class="history-sub-text"><strong>Actividad:</strong> ${l.activity}</div>
                            <div class="history-parts-list"><i class="bi bi-tools"></i> <strong>Repuestos usados:</strong><br>${l.repuestos}</div>
                        </div>`;
                    } else {
                        cont.innerHTML += `
                        <div class="history-box manual">
                            <div class="history-header">
                                <span class="badge bg-secondary" style="font-size:0.8rem; padding: 4px 10px;">MOV. MANUAL: ${l.user}</span>
                                <span class="history-time">${l.date}</span>
                            </div>
                            <div class="history-main-text" style="font-size: 1.05rem;">${l.desc}</div>
                        </div>`;
                    }
                });
            });
        };

        window.addNewItem = () => {
            if(restrictedUsers.includes(currentUser)) return;
            const n = document.getElementById('newItemName').value; const t = document.getElementById('newItemType').value; const q = parseInt(document.getElementById('newItemQty').value) || 0;
            if(!n) return alert("Nombre obligatorio"); push(ref(db, 'items'), { name: n, type: t, qty: q });
            bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
            document.getElementById('newItemName').value = '';
        };

        window.deleteItem = (id, n) => {
            if(restrictedUsers.includes(currentUser)) return;
            confirm(`¿Borrar ${n}?`) && remove(ref(db, `items/${id}`));
        }

        window.filterItems = () => {
            const t = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.item-card-wrapper').forEach(c => c.style.display = c.dataset.name.includes(t)?'block':'none');
        };

        const script = document.createElement('script'); script.src = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"; document.body.appendChild(script);
    </script>
</body>
</html>